---
title: "Untitled"
output: html_document
date: "2025-06-08"
---
Задание 1: Проведите разведывательный анализ данных, оценив входящие в датасет переменные. Выберите из них одну количественную и одну качественную переменные. При этом качественная переменная должна содержать не менее трех уровней. 

Оцените характер распределения количественной переменной и рассчитайте ключевые параметры описательной статистики, наиболее корректно представляющие эти данные (с учетом типа распределения). Разделите переменную, содержащую возраст пациента в годах, на возрастные группы по 25 лет (0–24, 25–49 и т. д.). Для качественной переменной рассчитайте параметры описательной статистики с учетом разделения на возрастные группы.

Задание 2. Постройте необходимые графики для визуализации проверки характера распределения, а также ключевых параметров описательной статистики, для наиболее полного представления данных по выбранным переменным. Интерпретируйте полученные результаты.
```{r setup, include=FALSE}
# Загрузка необходимых библиотек
library(dplyr)
library(ggplot2)
library(gridExtra)

data <- read.csv('kidney_disease_dataset.csv')
# Первые несколько строк
print(head(data))
```

```{r}
# Структура данных
str(data)
```

```{r}
```
Выберем:
Количественную переменную: Serum.creatinine..mg.dl. (уровень креатинина в сыворотке)
Качественная переменная: Physical.activity.level (уровень физической активности) с тремя уровнями: низкий, средний, высокий
```{r}
# анализируем количественную переменную 
library(scales)
# Основные статистики
summary(data$Serum.creatinine..mg.dl.)

# Проверка нормальности распределения
shapiro.test(sample(data$Serum.creatinine..mg.dl., 5000)) # ограничиваем выборку из-за ограничений теста

# построим необходимые базовые графики для оценки распределения

# Гистограмма распределения - 1 график
ggplot(data, aes(x = Serum.creatinine..mg.dl.)) +
  geom_histogram(bins = 30, fill = "lightblue", color = "black") +
  labs(title = "Распределение уровня креатинина в сыворотке",
       x = "Креатинин (mg/dl)", y = "Частота")

# График 2: Q-Q plot
ggplot(data, aes(sample = scale(Serum.creatinine..mg.dl.))) +
  stat_qq(color = "#6baed6") + 
  stat_qq_line(color = "#d94801") +
  labs(title = "C. Q-Q график нормальности распределения",
       x = "Теоретические квантили", y = "Выборочные квантили") +
  theme_minimal(base_size = 12)
```
```{r}
# Так как распределение не нормальное, используем медиану и IQR
cat("\nМедиана:", median(data$Serum.creatinine..mg.dl., na.rm = TRUE))
cat("\nМежквартильный размах:", IQR(data$Serum.creatinine..mg.dl., na.rm = TRUE))
```

ВЫВОДЫ: 
Уровень креатинина в сыворотке (Serum.creatinine..mg.dl.) имеет ненормальное распределение (тест Шапиро-Уилка p < 0,05). Q-Q график демонстрирует сильное отклонение от нормального распределения (точки значительно расходятся с теоретической линией).1-й квартиль (25%) = 4,20 мг/дл, 3-й квартиль (75%) = 11,43 мг/дл → Разброс значений значительный.  В качестве показателей центральной тенденции и разброса будем использовать медиану и межквартильный размах. 
Далее смотрим количественную переменную. 
```{r}
# Разделение на возрастные группы с шагом 25 лет
data <- data %>%
  mutate(age_group = cut(Age.of.the.patient,
                         breaks = seq(0, 100, by = 25),
                         labels = c("0-24", "25-49", "50-74", "75-99"),
                         include.lowest = TRUE))

# Проверка распределения
table(data$age_group)
```
```{r}
# Таблица частот
activity_table <- table(data$age_group, data$Physical.activity.level)
activity_table

# Визуализация
ggplot(data, aes(x = age_group, fill = Physical.activity.level)) +
  geom_bar(position = "dodge") +
  labs(title = "Распределение уровня физической активности по возрастным группам",
       x = "Возрастная группа", y = "Количество пациентов", fill = "Уровень активности")

# Статистики по группам
activity_stats <- data %>%
  group_by(age_group, Physical.activity.level) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(percentage = count / sum(count) * 100)

activity_stats

```
ВЫВОДЫ: 

Распределение пациентов по уровням физической активности (Physical.activity.level) в возрастных группах показывает, что:
В молодой группе (0-24 года) чаще встречается высокий уровень активности (“high”) (1714 пациентов), чем низкий (“low”) (1664).
В возрастной группе 50-74 и 25-74 года физическая активность суммарно выше чем в остальных группах, разница не велика, но если их сравнивать между собой то группа 50-74года преобладает, что вызывает некоторые вопросы, т.к обычно уровень физической активности должен снижаться к этому возрасту.
В старшей группе (75-99 лет) высокая физическая активность меньше остальных, что логично из-за возрастных ограничений.


Задание 3. С учетом проведенных ранее процедур, выберите соответствующий статистический тест для попарного сравнения количественной переменной, разделенной на группы качественной переменной. 
Выберите дополнительную качественную переменную и проведите сходную процедуру попарных сравнений. Используйте post-hoc тесты, поправки на множественные сравнения и графическую визуализацию результатов и проверки допущений тестов, где это уместно. Интерпретируйте полученные результаты.

Исходя из ранее проведенного анализа:
Количественная переменная - Распределение не является нормальным
Качественная переменная- имеет 3 уровня: low, moderate, high.
Рекомендуется использовать непараметрические тесты например в нашем случае - Тест Крускала-Уоллиса (Kruskal-Wallis) — непараметрический аналог однофакторного дисперсионного анализа.

Наша гипотеза:
H₀: Медианы креатинина одинаковы во всех группах.
H₁: Медианы различаются хотя бы в одной паре групп.
```{r}
# 1. Тест Крускала-Уоллиса
kruskal.test(Serum.creatinine..mg.dl. ~ Physical.activity.level, data = data)

```
p-значение = 0,2222 > 0,05 → нулевая гипотеза (H₀) не отвергается.
Вывод: Уровень креатинина не зависит от уровня физической активности пациентов в данном исследовании.

Выбор дополнительной качественной переменной
Для анализа выберем переменную Hypertension..yes.no. (наличие гипертонии у пациента) с двумя уровнями: yes и no
Беря за основу уже ранее известные данные сравним уровень креатинина и наличие гиперте=онии у пациентов для этого возьмем U-тест Манна-Уитни — непараметрический аналог t-теста.
```{r}
wilcox_result <- wilcox.test(
  Serum.creatinine..mg.dl. ~ Hypertension..yes.no.,
  data = data
)
print(wilcox_result)# Строим график с корректным p-value
ggplot(data, aes(x = Hypertension..yes.no., y = Serum.creatinine..mg.dl., fill = Hypertension..yes.no.)) +
  geom_boxplot() +
  labs(
    title = "Уровень креатинина у пациентов с гипертонией и без",
    x = "Наличие гипертонии",
    y = "Креатинин (mg/dl)",
    caption = paste("Тест Манна-Уитни, p =", round(wilcox_result$p.value, 4))
  ) +
  theme_minimal()
```
ВЫВОДЫ: 
Нет статистически значимых различий в уровне креатинина между пациентами с гипертонией (yes) и без гипертонии (no).
p-значение = 0,8735 > 0,05 → нулевая гипотеза (H₀) не отвергается.
Уровень креатинина в сыворотке крови не зависит от наличия гипертонии у пациентов (в данной выборке)


Задание 4. Для количественной переменной (выбранной ранее или новой) постройте модель линейной регрессии, включающую не менее трех предикторов, потенциально имеющих биологический смысл в виде причинно-следственных связей. 

Проверьте необходимые допущения метода с использованием количественных тестов и графической визуализации. Интерпретируйте полученные результаты. Постройте необходимую графическую визуализацию для их презентации.

Оставим ранее выбранную количественную переменную.Построим модель, предсказывающую уровень креатинина используя:

Основные предикторы которые я выбрала из списка:
Age.of.the.patient - возраст 
Blood.pressure..mm.Hg. - артериальное давление
Estimated.Glomerular.Filtration.Rate..eGFR. - прямой маркер функции почек 
Diabetes.mellitus..yes.no. - диабет как основная причина нефропатии 
Blood.urea..mg.dl. - азот мочевины в крови 
Urine.protein.to.creatinine.ratio - протеинурия 
Hypertension..yes.no. - гипертензия 

```{r}
data <- data %>%
  mutate(
    Diabetes_binary = ifelse(Diabetes.mellitus..yes.no. == "yes", 1, 0),
    Hypertension_binary = ifelse(Hypertension..yes.no. == "yes", 1, 0)
  )

# Построение модели
model <- lm(
  Serum.creatinine..mg.dl. ~ 
    Age.of.the.patient +
    Blood.pressure..mm.Hg. +
    Estimated.Glomerular.Filtration.Rate..eGFR. +
    Diabetes_binary +
    Blood.urea..mg.dl. +
    Urine.protein.to.creatinine.ratio +
    Hypertension_binary,
  data = data
)

# Краткий вывод
summary(model)
```

```{r}
# Нормальность остатков (Шапиро-Уилк)
sh <- shapiro.test(sample(residuals(model), 5000))
print(sh)


# Гомоскедастичность (Бреуша-Пагана)

lmtest::bptest(model)

```
```{r}
# График предсказанные vs наблюдаемые значения
p1 <- ggplot(data, aes(x = predict(model), y = Serum.creatinine..mg.dl.)) +
  geom_point(alpha = 0.5, color = "blue") +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Предсказанные vs Наблюдаемые значения",
       x = "Предсказанный креатинин", y = "Фактический креатинин")

# График остатков
p2 <- ggplot(data, aes(x = predict(model), y = residuals(model))) +
  geom_point(alpha = 0.5, color = "darkgreen") +
  geom_hline(yintercept = 0, color = "red") +
  labs(title = "Остатки модели", x = "Предсказанные значения", y = "Остатки")

# Q-Q plot остатков
p3 <- ggplot(data, aes(sample = residuals(model))) +
  stat_qq() + stat_qq_line(color = "red") +
  labs(title = "Q-Q plot остатков")

# Компоновка графиков
grid.arrange(p1, p2, p3, ncol = 2)
```


Нормальность остатков (Шапиро-Уилк):
Тест показал крайне значимый результат (p < 0,001)
Это означает, что остатки модели не распределены нормально
Гомоскедастичность (Бреуша-Пагана):
p-значение > 0,05 (незначимо)
Гипотеза о гомоскедастичности не отвергается
Остатки имеют постоянную дисперсию

ВЫВОДЫ: Ни один из коэффициентов не является статистически значимым (все p > 0,05).

Наиболее близкие к значимым предикторы:
Мочевина в крови, мг/дл (p = 0,156)
Возраст пациента (p = 0,212)
Ключевая проблема: очень слабая объяснительная способность модели (R² = 0,0003, т.е. 0,03% вариации креатинина объясняется предикторами)
График остатков: Систематических закономерностей нет, но разброс велик.
Q-Q-диаграмма: сильные отклонения от нормальности в хвостах распределения.
```{r}

```
Задание 5.  Для качественной бинарной переменной (выбранной ранее или новой) постройте модель логистической регрессии, включающую не менее трех предикторов, потенциально имеющих биологический смысл в виде причинно-следственных связей. 

Проверьте необходимые допущения метода с использованием количественных тестов и графической визуализации. Интерпретируйте полученные результаты. Постройте необходимую графическую визуализацию для их презентации.

Зависимая переменная:
Hypertension..yes.no. (наличие гипертонии, бинарная переменная: «да»/«нет»)

Предикторы (выбраны на основе биологической значимости):
Age.of.the.patient – возраст
BMI – индекс массы тела 
Diabetes_binary – наличие диабета (1=”да”, 0=”нет”, диабет часто сопутствует гипертонии).

```{r}
# Создаем бинарную переменную (0="no", 1="yes")
data$Hypertension_binary <- ifelse(data$Hypertension..yes.no. == "yes", 1, 0)
data$Diabetes_binary <- ifelse(data$Diabetes.mellitus..yes.no. == "yes", 1, 0)

# Теперь модель с бинарными переменными:
model_logit <- glm(
  Hypertension_binary ~ Age.of.the.patient + Blood.pressure..mm.Hg. + Diabetes_binary,
  data = data,
  family = binomial()
)

# Вывод результатов
summary(model_logit)
```

```{r}
ggplot(data, aes(x = Age.of.the.patient, y = Hypertension_binary)) +
  geom_jitter(height = 0.05, alpha = 0.2) +
  geom_smooth(method = "glm", method.args = list(family = "binomial")) +
  labs(title = "Вероятность гипертонии от возраста",
       x = "Возраст", y = "Вероятность гипертонии")
```
```{r}
library(broom)
library(ggplot2)
#График коэффициентов (OR с доверительными интервалами)
coef_plot <- tidy(model_logit, conf.int = TRUE, exponentiate = TRUE) %>% 
  filter(term != "(Intercept)") %>%
  ggplot(aes(x = estimate, y = term, xmin = conf.low, xmax = conf.high)) +
  geom_point() +
  geom_errorbar(width = 0.2) +
  geom_vline(xintercept = 1, color = "red", linetype = "dashed") +
  labs(title = "Отношение шансов (OR) для предикторов гипертонии",
       x = "OR (логарифмическая шкала)", y = "") +
  scale_x_log10() 

coef_plot
# Интерпретация:
#ИЛИ = 1 → нет эффекта.
#OR < 1 → снижение шансов гипертонии (Diabetes_binary).
#Широкие доверительные интервалы (нет значимости у возраста и давления).
```
```{r}
```
```{r}
```


ВЫВОДЫ: на удивление получила неожиданные результаты = 
Некорректные направления связей:
- Давление должно быть положительно связано с гипертонией, но коэффициент отрицательный.
- Диабет обычно повышает риск гипертонии, но здесь наблюдается обратный эффект.
Незначимость предикторов (кроме диабета):
- Возраст и давление не внесли значимого вклада (p > 0,05).
Слабая предсказательная способность:
- Разница между нулевым отклонением (28471) и остаточным отклонением (28466) минимальна.

Возможно стоит перепроверить данные на корректность внесения в датасет

```{r}

```

```{r}

```

